---
title: "Building an AI Agent for Automated Bill Payments"
description: "Create an AI-powered application that extracts payment details from bills and processes payments"
icon: "money-bill"
---

<Frame caption="Bill Buddy">
<img height="200" src="/images/bill-buddy.png" />
</Frame>

In this tutorial, we'll build "Bill Buddy" - an AI-powered bill payment agent that combines OCR, AI analysis, and Payman to create a seamless payment experience.

## What We're Building

Bill Buddy is a Streamlit application that:

1. Takes a bill (PDF or image) as input
2. Extracts text using OCR
3. Uses AI to identify payment details (account numbers, amounts, due dates)
4. Sends payments via Payman's API

Let's dive in! ðŸš€

## Prerequisites

- Python 3.8+
- OpenAI API key
- Payman API key (check out [Get API Key](/api-reference/get-api-key) section)
- Basic understanding of Python

## Step 1: Setup Your Environment

Let's start by setting up our project environment:

```bash
# Create a new directory for our project
mkdir bill-buddy
cd bill-buddy

# Create and activate a virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install required packages
pip install streamlit pytesseract pymupdf openai paymanai pillow python-dotenv
```

## Step 2: Create the Application Structure

Let's set up our main Streamlit application:

```python
# app.py
import streamlit as st
import os
import tempfile
from PIL import Image
import pytesseract
import fitz  # PyMuPDF
import openai
from paymanai import Paymanai
import json
import re

# Configure the app
st.set_page_config(
    page_title="Bill Buddy - AI Bill Payment Agent",
    page_icon="ðŸ’°",
    layout="wide"
)

# Initialize API keys (preferably from environment variables)
openai_api_key = os.environ.get("OPENAI_API_KEY", "")
payman_api_key = os.environ.get("PAYMAN_API_KEY", "")

# Constants
ACCOUNT_TYPES = ["checking", "savings"]
HOLDER_TYPES = ["individual", "business"]
```

## Step 3: Implement Text Extraction

We'll need to extract text from both PDFs and images:

```python
def extract_text_from_pdf(uploaded_file):
    """Extract text from PDF using PyMuPDF (fitz)"""
    with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as temp_pdf:
        temp_pdf.write(uploaded_file.getvalue())
        temp_pdf_path = temp_pdf.name
    
    text = ""
    try:
        # Open the PDF with PyMuPDF
        doc = fitz.open(temp_pdf_path)
        
        # Extract text from each page
        for page in doc:
            text += page.get_text()
        
        # Close the document
        doc.close()
    except Exception as e:
        st.error(f"Error extracting text from PDF: {e}")
    finally:
        # Clean up the temporary file
        os.unlink(temp_pdf_path)
    
    return text

def extract_text_from_image(uploaded_file):
    """Extract text from image using pytesseract"""
    image = Image.open(uploaded_file)
    text = pytesseract.image_to_string(image)
    return text
```

## Step 4: Payment Information Extraction with AI

This is where the magic happens! We'll use OpenAI to extract payment details from the raw text:

```python
def extract_payment_info(text):
    """Extract payment information from text using OpenAI API"""
    client = openai.OpenAI(api_key=openai_api_key)
    
    system_prompt = """
    You are a specialized AI for extracting payment information from bills. 
    Extract the following details from the text of a bill:
    - Payee name (the company or person to be paid)
    - Account holder name (the name on the bank account)
    - Bank account number
    - Routing number
    - Account type (checking or savings, default to checking if unclear)
    - Account holder type (individual or business, default to individual if unclear)
    - Amount to be paid
    - Payment due date
    
    Return ONLY a JSON object with these fields: 
    {
        "name": "string",
        "account_holder_name": "string",
        "account_number": "string",
        "routing_number": "string",
        "account_type": "checking|savings",
        "account_holder_type": "individual|business",
        "amount": float,
        "due_date": "YYYY-MM-DD"
    }
    
    If any field is not found in the text, make your best guess or use empty string or 0.0 for amount.
    """
    
    # Try with GPT-4 first, fall back to GPT-3.5-turbo if needed
    models = ["gpt-4", "gpt-3.5-turbo-1106", "gpt-3.5-turbo"]
    
    for model in models:
        try:
            response = client.chat.completions.create(
                model=model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": text}
                ],
                response_format={"type": "json_object"} if model in ["gpt-4-turbo", "gpt-4-0125-preview", "gpt-3.5-turbo-1106"] else None
            )
            
            # Parse the JSON response
            return json.loads(response.choices[0].message.content)
                
        except Exception as e:
            continue
    
    # If we've tried all models and none worked
    st.error("Failed to extract payment information from the bill")
    return None
```

## Step 5: Connect with Payman for Payments

Now let's implement the payment processing with Payman:

```python
def send_payment(payment_info):
    """Send payment using Payman API"""
    try:
        payman = Paymanai(
            x_payman_api_secret=payman_api_key,
            environment="sandbox"  # Change to "production" for real payments
        )
        
        # First check if the payee already exists
        existing_payees = payman.payments.search_payees(name=payment_info["name"])
        payee_list = []
        
        # Handle different response formats
        if isinstance(existing_payees, list):
            payee_list = existing_payees
        elif isinstance(existing_payees, dict) and "data" in existing_payees:
            payee_list = existing_payees["data"]
        
        # Check if we found an existing payee
        payee_id = None
        if payee_list and len(payee_list) > 0:
            for payee in payee_list:
                if isinstance(payee, dict) and "id" in payee:
                    payee_id = payee["id"]
                    break
        
        # If no existing payee found, create a new one
        if not payee_id:
            # Create a new payee
            payee_response = payman.payments.create_payee(
                type="US_ACH",
                name=payment_info["name"],
                account_holder_name=payment_info["account_holder_name"],
                account_number=payment_info["account_number"],
                routing_number=payment_info["routing_number"],
                account_type=payment_info["account_type"],
                account_holder_type=payment_info["account_holder_type"],
                contact_details={}
            )
            
            # Get the payee ID from the response
            if hasattr(payee_response, "id"):
                payee_id = payee_response.id
        
        # Send the payment
        if payee_id:
            payment_response = payman.payments.send_payment(
                amount_decimal=float(payment_info["amount"]),
                payment_destination_id=payee_id,
                memo=f"Payment for bill due on {payment_info.get('due_date', 'N/A')}"
            )
            
            # Extract reference if available
            payment_reference = None
            if hasattr(payment_response, "reference"):
                payment_reference = payment_response.reference
                return {"reference": payment_reference}
            
            return {"status": "request_sent"}
            
        return None
            
    except Exception as e:
        st.error(f"Error processing payment: {str(e)}")
        return None
```

## Step 6: Build the UI

Let's put everything together with a streamlined UI:

```python
def main():
    st.title("Bill Buddy - AI Bill Payment Agent ðŸ’°")
    st.write("Upload your bill, we'll extract payment details and help you pay it!")
    
    # File upload
    uploaded_file = st.file_uploader("Upload a bill (PDF, JPG, PNG)", type=["pdf", "jpg", "jpeg", "png"])
    
    if uploaded_file:
        # Main processing container
        with st.container():
            # Create a single progress indicator
            progress_placeholder = st.empty()
            
            # Step 1: Extract text
            progress_placeholder.info("Processing your bill...")
            
            # Extract text based on file type
            if uploaded_file.type == "application/pdf":
                text = extract_text_from_pdf(uploaded_file)
            else:  # Image file
                text = extract_text_from_image(uploaded_file)
            
            # Step 2: Extract payment information
            progress_placeholder.info("Analyzing bill with AI...")
            payment_info = extract_payment_info(text)
            
            # Clear the progress indicator
            progress_placeholder.empty()
            
            if payment_info:
                # Display extracted information
                st.subheader("Extracted Payment Information")
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write("**Payee Name:**", payment_info.get("name", ""))
                    st.write("**Account Holder:**", payment_info.get("account_holder_name", ""))
                    st.write("**Account Number:**", payment_info.get("account_number", ""))
                    st.write("**Routing Number:**", payment_info.get("routing_number", ""))
                
                with col2:
                    st.write("**Account Type:**", payment_info.get("account_type", "checking"))
                    st.write("**Holder Type:**", payment_info.get("account_holder_type", "individual"))
                    st.write("**Amount:**", f"${payment_info.get('amount', 0.0):.2f}")
                    st.write("**Due Date:**", payment_info.get("due_date", ""))
                
                # Form for editing payment information
                st.subheader("Edit Payment Information (if needed)")
                with st.form("payment_form"):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        name = st.text_input("Payee Name", value=payment_info.get("name", ""))
                        account_holder = st.text_input("Account Holder", value=payment_info.get("account_holder_name", ""))
                        account_number = st.text_input("Account Number", value=payment_info.get("account_number", ""))
                        routing_number = st.text_input("Routing Number", value=payment_info.get("routing_number", ""))
                    
                    with col2:
                        account_type = st.selectbox("Account Type", ACCOUNT_TYPES, index=ACCOUNT_TYPES.index(payment_info.get("account_type", "checking")) if payment_info.get("account_type", "") in ACCOUNT_TYPES else 0)
                        holder_type = st.selectbox("Holder Type", HOLDER_TYPES, index=HOLDER_TYPES.index(payment_info.get("account_holder_type", "individual")) if payment_info.get("account_holder_type", "") in HOLDER_TYPES else 0)
                        amount = st.number_input("Amount", value=float(payment_info.get("amount", 0.0)), min_value=0.0, step=0.01, format="%.2f")
                        due_date = st.date_input("Due Date", value=None)
                    
                    # Update payment info
                    payment_info.update({
                        "name": name,
                        "account_holder_name": account_holder,
                        "account_number": account_number,
                        "routing_number": routing_number,
                        "account_type": account_type,
                        "account_holder_type": holder_type,
                        "amount": amount,
                        "due_date": str(due_date) if due_date else ""
                    })
                    
                    # Submit button
                    submitted = st.form_submit_button("Pay Bill")
                    
                    if submitted:
                        # Validate required fields
                        required_fields = ["name", "account_holder_name", "account_number", "routing_number", "amount"]
                        missing_fields = [field for field in required_fields if not payment_info.get(field)]
                        
                        if missing_fields:
                            st.error(f"Missing required fields: {', '.join(missing_fields)}")
                        else:
                            # Payment processing
                            payment_progress = st.empty()
                            payment_progress.info("Processing payment...")
                            
                            payment_result = send_payment(payment_info)
                            
                            # Clear the progress indicator
                            payment_progress.empty()
                            
                            if payment_result:
                                st.success("âœ… Payment request successfully created!")
                                
                                # Show reference ID if available
                                if "reference" in payment_result:
                                    st.info(f"Reference ID: {payment_result.get('reference', 'N/A')}")
                                
                                st.warning("Important: The payment requires manual approval in your Payman dashboard.")
                                st.markdown("""
                                ### Next steps:
                                1. Go to your [Payman Dashboard](https://app.paymanai.com)
                                2. Navigate to the "Requests" section
                                3. Find this payment request and approve it
                                """)
            else:
                st.error("Failed to extract payment information from the bill. Please try again with a clearer image or PDF.")

if __name__ == "__main__":
    main()
```

## Step 7: Run Your Application

Save your code and run the Streamlit application:

```bash
streamlit run app.py
```

And voilÃ ! You now have a functioning bill payment AI agent. ðŸŽ‰

## How It Works

Let's break down the key components:

1. **Text Extraction**: We use PyMuPDF for PDFs and pytesseract for images to extract raw text.

2. **AI Analysis**: OpenAI processes the text to identify payment-related information like account numbers, routing numbers, and amounts.

3. **Payman Integration**: 
   - We search for existing payees to avoid duplicates
   - If needed, we create a new payee
   - We send payment with the extracted/confirmed information
   - We guide the user to approve the payment in their Payman dashboard

4. **User Experience**: The Streamlit UI provides a simple interface for:
   - Uploading bills
   - Reviewing extracted information
   - Editing information if needed
   - Sending payments
   - Seeing next steps


## Secure API Keys

Use environment variables or Streamlit secrets for your API keys:

```python
# Create a .env file with your API keys
OPENAI_API_KEY=your_openai_key
PAYMAN_API_KEY=your_payman_key
```

## Conclusion

Congratulations! ðŸŽ‰ You've built a complete AI-powered bill payment system that:

1. Extracts information from bills automatically
2. Uses AI to understand the content
3. Sends payments through Payman
4. Provides a clean user interface

This is just the beginning of what's possible with Payman and AI. You could extend this to handle recurring payments, support different payment methods, or integrate with accounting software.
